# Docker Compose for Production Environment - v0.7
# Synology NAS deployment with pre-compiled backend executable
# NO Mongo Express in production

version: '3.8'

# Project name for Synology Container Manager
name: setprod

services:
  # Backend Container (runtime only - no development tools)
  backend-container:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - USER_UID=${USER_UID:-1026}
        - USER_GID=${USER_GID:-110}
        - USERNAME=${USERNAME:-rustdev}
        - GROUPNAME=${GROUPNAME:-rustdevteam}
    
    image: setprod-backend:0.7.0
    container_name: ${CONTAINER_NAME:-setprod-backend}
    hostname: ${HOSTNAME:-setprod-backend-host}
    restart: always
    
    ports:
      - "${APP_PORT:-5646}:8080"
    
    environment:
      # Application port (inside container)
      - APP_PORT=8080
      
      # MongoDB connection
      - MONGO_HOST=mongo-db
      - MONGO_PORT=27017
      - DB_NAME=${DB_NAME:-rust_app_db}
      - DB_USER=${DB_USER:-app_user}
      - DB_PASSWORD=${DB_PASSWORD:-app_password}
      - COLLECTION_1=${COLLECTION_1:-setplayers}
      - COLLECTION_2=${COLLECTION_2:-setgames}
      - COLLECTION_3=${COLLECTION_3:-setstats}
      
      # Logging
      - RUST_LOG=${RUST_LOG:-info}
      - RUST_BACKTRACE=1
      
      # Environment
      - ENV_STATUS=PRODUCTION
    
    volumes:
      # Only mount data directory (no source code needed)
      - ${PROJECT_PATH}/data:/data
    
    networks:
      - ${NETWORK_NAME:-prod-network}
    
    depends_on:
      mongo-db:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Application runs automatically via CMD in Dockerfile

  # MongoDB Database
  mongo-db:
    image: ${MONGO_IMAGE:-mongo:7.0.15-jammy}
    container_name: ${CONTAINER_MONGODB:-setprod-mongodb}
    hostname: mongo-db
    restart: always
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${DB_ADMIN_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${DB_ADMIN_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${DB_NAME:-rust_app_db}
    
    volumes:
      - ${VOLUME_MONGODB_DATA}:/data/db
      - ${VOLUME_MONGODB_INIT}:/docker-entrypoint-initdb.d:ro
    
    networks:
      - ${NETWORK_NAME:-prod-network}
    
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  prod-network:
    name: ${NETWORK_NAME:-prod-network}
    driver: bridge
