# Docker Compose for Production Environment - v0.4
# Synology NAS deployment - NO SSH, NO Mongo Express

version: '3.8'

services:
  # Server Container (production)
  server-container:
    build:
      context: ../common
      dockerfile: dockerfile.v0.4
      args:
        - USER_UID=${USER_UID:-1026}
        - USER_GID=${USER_GID:-110}
        - USERNAME=${USERNAME:-rustdev}
        - GROUPNAME=${GROUPNAME:-rustdevteam}
    
    container_name: ${CONTAINER_NAME:-server-container}
    hostname: ${HOSTNAME:-server-host}
    restart: unless-stopped
    
    ports:
      - "${APP_PORT:-5666}:8080"        # Application web interface (proxied)
    
    environment:
      - MONGODB_URI=mongodb://mongo-db:27017/${DB_NAME:-rust_app_db}
      - MONGODB_HOST=mongo-db
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=${DB_NAME:-rust_app_db}
      - MONGODB_USER=${DB_USER:-app_user}
      - MONGODB_PASSWORD=${DB_PASSWORD:-app_password}
      - RUST_LOG=${RUST_LOG:-warn}
      - DEPLOY_ENV=prod
    
    volumes:
      - ${PROJECT_PATH}:/workspace/${PROJECT_DIR}
      - ${VOLUME_CARGO_CACHE}:/home/${USERNAME:-rustdev}/.cargo/registry
      - ${VOLUME_TARGET_CACHE}:/workspace/target
    
    networks:
      - ${NETWORK_NAME:-prod-network}
    
    depends_on:
      - mongo-db
    
    # Keep container running (no SSH daemon needed)
    command: tail -f /dev/null

  # MongoDB Database
  mongo-db:
    image: ${MONGO_IMAGE:-mongo:7.0-jammy}
    container_name: ${CONTAINER_MONGODB:-prod-mongodb}
    hostname: mongo-db
    restart: unless-stopped
    
    # MongoDB port NOT exposed to host in production
    # Only accessible via internal Docker network
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${DB_ADMIN_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${DB_ADMIN_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${DB_NAME:-rust_app_db}
    
    volumes:
      - ${VOLUME_MONGODB_DATA}:/data/db
      - ${VOLUME_MONGODB_INIT}:/docker-entrypoint-initdb.d:ro
    
    networks:
      - ${NETWORK_NAME:-prod-network}

  # NOTE: Mongo Express NOT included in production for security

# All volumes are bind mounts to Synology NAS directories
networks:
  prod-network:
    name: ${NETWORK_NAME:-prod-network}
    driver: bridge
