# filepath: docker-compose-v03.yml - Version 0.3
# 
# Generic Rust Development Environment with .env Configuration Support
# Copy .env.example to .env and customize for your project
#
version: '3.8'

services:
  # Rust development container
  rust-dev:
    build:
      context: .
      dockerfile: dockerfile.v0.3
      args:
        - USER_UID=${USER_UID:-1026}
        - USER_GID=${USER_GID:-110}
        - USERNAME=${USERNAME:-rustdev}
        - GROUPNAME=${GROUPNAME:-rustdevteam}
    
    container_name: ${CONTAINER_RUST_DEV:-rust-dev-container}
    hostname: ${HOSTNAME_RUST_DEV:-rust-dev}
    
    # Port mappings
    ports:
      - "${SSH_PORT:-2222}:22"        # SSH access
      - "${APP_PORT:-8080}:8080"      # Application port
    
    # Environment variables for MongoDB connection
    environment:
      - MONGODB_URI=mongodb://mongo-db:27017/${DB_NAME:-rust_app_db}
      - MONGODB_HOST=mongo-db
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=${DB_NAME:-rust_app_db}
      - MONGODB_USER=${DB_USER:-app_user}
      - MONGODB_PASSWORD=${DB_PASSWORD:-app_password}
      - RUST_LOG=${RUST_LOG:-debug}
    
    # Volume mounts
    volumes:
      # Project source code
      - ./${PROJECT_DIR:-rust_project}:/workspace/${PROJECT_DIR:-rust_project}
      # Cargo cache for faster builds
      - ${VOLUME_CARGO_CACHE:-cargo-cache}:/home/${USERNAME:-rustdev}/.cargo/registry
      - ${VOLUME_TARGET_CACHE:-target-cache}:/workspace/target
    
    networks:
      - ${NETWORK_NAME:-dev-network}
    
    depends_on:
      - mongo-db
    
    tty: true
    stdin_open: true

  # MongoDB database server
  mongo-db:
    image: ${MONGO_IMAGE:-mongo:7.0-jammy}
    container_name: ${CONTAINER_MONGODB:-rust-mongodb}
    hostname: mongo-db
    restart: unless-stopped
    
    ports:
      - "${MONGO_PORT:-27017}:27017"
    
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${DB_ADMIN_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${DB_ADMIN_PASSWORD:-admin123}
      MONGO_INITDB_DATABASE: ${DB_NAME:-rust_app_db}
    
    volumes:
      - ${VOLUME_MONGODB_DATA:-mongodb-data}:/data/db
      - ./docker/mongo-init:/docker-entrypoint-initdb.d:ro
    
    networks:
      - ${NETWORK_NAME:-dev-network}

  # Mongo Express - Web-based MongoDB admin interface
  mongo-express:
    image: ${MONGO_EXPRESS_IMAGE:-mongo-express:1.0.0-alpha}
    container_name: ${CONTAINER_MONGO_EXPRESS:-rust-mongo-express}
    restart: unless-stopped
    
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${DB_ADMIN_USER:-admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${DB_ADMIN_PASSWORD:-admin123}
      ME_CONFIG_MONGODB_URL: mongodb://${DB_ADMIN_USER:-admin}:${DB_ADMIN_PASSWORD:-admin123}@mongo-db:27017/
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-dev}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-dev123}
    
    depends_on:
      - mongo-db
    
    networks:
      - ${NETWORK_NAME:-dev-network}

volumes:
  mongodb-data:
    name: ${VOLUME_MONGODB_DATA:-mongodb-data}
  cargo-cache:
    name: ${VOLUME_CARGO_CACHE:-cargo-cache}
  target-cache:
    name: ${VOLUME_TARGET_CACHE:-target-cache}

networks:
  dev-network:
    name: ${NETWORK_NAME:-dev-network}
    driver: bridge